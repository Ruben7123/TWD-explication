<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Stack+Sans+Notch:wght@200..700&display=swap" rel="stylesheet">
  <link rel="icon" href="../favicon.jpg" type="image/jpg">
  <link href="../styles.css" rel="stylesheet" />
</head>
<html>
<body>
<div class="sidebar">
    <div class="folder">
      <div class="element">
        <a>Saisons</a>
        <div class="dropdown">
          <a href ="../index.html?page=s01">Saison 1</a>
          <a href ="?page=s02">Saison 2</a>
          <a href ="?page=s03">Saison 3</a>
          <a href ="?page=s04">Saison 4</a>
          <a href ="?page=s05">Saison 5</a>
          <a href ="?page=s06">Saison 6</a>
          <a href ="?page=s07">Saison 7</a>
          <a href ="?page=s08">Saison 8</a>
          <a href ="../index.html?page=s09">Saison 9</a>
          <a href ="../index.html?page=s10">Saison 10</a>
          <a href ="../index.html?page=s11">Saison 11</a>
        </div>
        <a>En +</a>
        <div class="dropdown">
          <a href ="../index.html?page=acteur">casting</a>
          <a href ="../index.html?page=lore"> le lore ?</a>
          <a href ="../index.html?page=amc"> AMC </a>
        </div>
      </div>
    </div>
  </div>
  
    <div class="main_panel">
    </div>
</body>
<script>
    const params = new URLSearchParams(window.location.search);
    const page = params.get("page") || "landing-page";
    const titles = {
    "s02": "Saison 2",
    "s03": "Saison 3",
    "s04": "Saison 4",
    "s05": "Saison 5",
    "s06": "Saison 6",
    "s07": "Saison 7",
    "s08": "Saison 8",
    };

    document.title = `TWD - ${titles[page] || "Inconnu"}`;
    const mainPanel = document.querySelector(".main_panel");
    let actorsData = [];

        async function loadActorsData() {
      try {
        const response = await fetch('../src/json/modals.json');
        actorsData = await response.json();
      } catch (error) {
        console.error('❌ Erreur lors du chargement des données:', error);
      }
    } 

  function generateActorCards(season) {
    const seasonData = actorsData.find(s => s.season === season);
    if (!seasonData || !seasonData.actors.length) {
      return '<p>Aucun acteur trouvé pour cette saison.</p>';
    }

  return seasonData.actors.map(actor => `
    <div class="actor-card" data-actor="${actor.actor}">
      <div id="actor-profile">
        <img src="${actor.img}" alt="${actor.actor}"/>
        <h3>${actor.actor}</h3>
        <p>${actor.quickdescription}</p>
      </div>
    </div>
  `).join('');
}

    async function renderPage() {
      await loadActorsData();

      switch (page) {
        case "s02":
          mainPanel.innerHTML = `
            <h1 class="saison-header">Saison 2</h1>
            <div class="casting-card">
              <h2>Les personnages principaux :</h2>
              <div class="casting">
                ${generateActorCards('s02')}
              </div>
            </div>
            <div class="content">
              <h2 class="content-header">Résumé de la saison 2</h2>
              
          `;
          break;
        case "s03":
          mainPanel.innerHTML = `
            <h1 class="saison-header">Saison 3</h1>
            <div class="casting-card">
              <h2>Les personnages principaux :</h2>
              <div class="casting">
                ${generateActorCards('s03')}
              </div>
            </div>
            <div class="content">
              <h2 class="content-header">Résumé de la saison 3</h2>
            </div>
          `;
          break;
        case "s04":
          mainPanel.innerHTML = `
            <h1 class="saison-header">Saison 4</h1>
            <div class="casting-card">
              <h2>Les personnages principaux :</h2>
              <div class="casting">
                ${generateActorCards('s04')}
              </div>
            </div>
            <div class="content">
              <h2 class="content-header">Résumé de la saison 4</h2>
            </div>
          `;
          break;
        case "s05":
          mainPanel.innerHTML = `
            <h1 class="saison-header">Saison 5</h1>
            <div class="casting-card">
              <h2>Les personnages principaux :</h2>
              <div class="casting">
                ${generateActorCards('s05')}
              </div>
            </div>
            <div class="content">
              <h2 class="content-header">Résumé de la saison 5</h2>
            </div>
          `;
          break;
        case "s06":
          mainPanel.innerHTML = `
            <h1 class="saison-header">Saison 6</h1>
            <div class="casting-card">
              <h2>Les personnages principaux :</h2>
              <div class="casting">
                ${generateActorCards('s06')}
              </div>
            </div>
            <div class="content">
              <h2 class="content-header">Résumé de la saison 6</h2>
            </div>
          `;
          break;
        case "s07":
          mainPanel.innerHTML = `
            <h1 class="saison-header">Saison 7</h1>
            <div class="casting-card">
              <h2>Les personnages principaux :</h2>
              <div class="casting">
                ${generateActorCards('s07')}
              </div>
            </div>
            <div class="content">
              <h2 class="content-header">Résumé de la saison 7</h2>
            </div>
          `;
          break;
        case "s08":
          mainPanel.innerHTML = `
            <h1 class="saison-header">Saison 8</h1>
            <div class="casting-card">
              <h2>Les personnages principaux :</h2>
              <div class="casting">
                ${generateActorCards('s08')}
              </div>
            </div>
            <div class="content">
              <h2 class="content-header">Résumé de la saison 8</h2>
            </div>
          `;
          break;
attachEventListeners();
      addTooltips();
    }

    function attachEventListeners() {
      document.querySelectorAll('.folder .element > a').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const dropdown = link.nextElementSibling;
          if (dropdown) {
            dropdown.style.display = dropdown.style.display === 'flex' ? 'none' : 'flex';
          }
        });
      });

      document.addEventListener('click', e => {
        if (!e.target.closest('.folder .element')) {
          document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
        }
      });

      document.querySelector('.close-warning')?.addEventListener('click', () => {
        document.querySelector('.warning').remove();
      });

      // Navigation entre saisons
      const totalSeasons = 11;
      const navContainer = document.createElement("div");
      navContainer.className = "nav_button";
      let navHTML = "";

      if (page.startsWith("s")) {
        const currentSeason = parseInt(page.slice(1));
        if (currentSeason > 1) {
          const prevPage = `s${String(currentSeason - 1).padStart(2, "0")}`;
          navHTML += `<button class="prev-btn" onclick="window.location.href='?page=${prevPage}'"> <img src="../src/img/back_arrow.svg" width="18" height="18"> Saison ${currentSeason - 1}</button>`;
        } else {
          navHTML += `<button class="home-btn" onclick="window.location.href='?page=landing-page'">Accueil</button>`;
        }
        if (currentSeason < totalSeasons) {
          const nextPage = `s${String(currentSeason + 1).padStart(2, "0")}`;
          navHTML += `<button class="next-btn" onclick="window.location.href='?page=${nextPage}'">Saison ${currentSeason + 1} <img src="../src/img/arrow.svg" width="18" height="18"></button>`;
        } else {
          navHTML += `<button class="home-btn" onclick="window.location.href='../index.html?page=acteur'">Vers le casting</button>`;
        }

        navContainer.innerHTML = navHTML;
        mainPanel.appendChild(navContainer);
      }

      // Active tab
      const currentSeason = params.get("page");
      if (currentSeason && currentSeason.startsWith("s")) {
        const link = document.querySelector(`.dropdown a[href='?page=${currentSeason}']`);
        if (link) {
          link.id = "active-tab";
        }
      }

      // Attacher les modals
      refreshCastingModals();
    }

    function attachModalToCasting() {
  const actorCards = document.querySelectorAll(".actor-card");
  actorCards.forEach(card => {
    card.style.cursor = "pointer";

    card.addEventListener("click", (e) => {
      const actorName = card.getAttribute('data-actor');
      
      // Chercher l'acteur dans toutes les saisons
      let actorInfo;
      for (const season of actorsData) {
        actorInfo = season.actors.find(a => a.actor === actorName);
        if (actorInfo) break;
      }

      if (actorInfo) {
        openModal(actorInfo);
      }
    });
  });
}

    function openModal(actor) {
      let modal = document.getElementById("modal");
      if (!modal) {
        modal = document.createElement("div");
        modal.id = "modal";
        modal.classList.add("modal");
        document.body.appendChild(modal);
      }

      modal.innerHTML = `
        <div class="modal-content">
          <button class="close-modal">×</button>
          <img src="${actor.img}" alt="${actor.actor}">
          <h2>${actor.actor}</h2>
          <h4 class="description">${actor.quickdescription}</h4>
          <p>${actor.fulldescription}</p>
        </div>
      `;

      modal.classList.add("active");

      modal.querySelector(".close-modal").addEventListener("click", () => modal.classList.remove("active"));
      modal.addEventListener("click", e => {
        if (e.target === modal) modal.classList.remove("active");
      });
    }

    function refreshCastingModals() {
      attachModalToCasting();
    }
const tooltips = {
  "Rick": "Shérif adjoint, leader du groupe",
  "Rick Grimes": "Shérif adjoint, leader du groupe",
  "Daryl": "Chasseur et traqueur expert à l’arbalète",
  "Daryl Dixon": "Chasseur et traqueur expert à l’arbalète",
  "Michonne": "Guerrière au katana",
  "Michonne Hawthorne": "Guerrière au katana",
  "Carol": "Combattante impitoyable et stratège",
  "Carol Peletier": "Combattante impitoyable et stratège",
  "Glenn": "Livreur de pizzas devenu explorateur courageux",
  "Glenn Rhee": "Livreur de pizzas devenu explorateur courageux",
  "Maggie": "Leader de Hilltop",
  "Maggie Rhee": "Leader de Hilltop",
  "Maggie Greene": "Leader de Hilltop",
  "Negan": "Leader charismatique et brutal des Sauveurs",
  "Negan Smith": "Leader charismatique et brutal des Sauveurs",
  "Carl": "Fils de Rick",
  "Carl Grimes": "Fils de Rick",
  "Judith": "Fille de Rick et Michonne",
  "Judith Grimes": "Fille de Rick et Michonne",
  "Morgan": "Maître du bâton, « toute vie est précieuse »",
  "Morgan Jones": "Maître du bâton, « toute vie est précieuse »",
  "Lori": "Épouse de Rick",
  "Lori Grimes": "Épouse de Rick",
  "Shane": "Meilleur ami et rival de Rick",
  "Shane Walsh": "Meilleur ami et rival de Rick",
  "Andrea": "Tireuse d’élite",
  "Dale": "Conscience morale du groupe",
  "T-Dog": "Membre loyal du groupe d’Atlanta",
  "Merle": "Frère aîné de Daryl",
  "Merle Dixon": "Frère aîné de Daryl",
  "Hershel": "Vétérinaire et patriarche",
  "Hershel Greene": "Vétérinaire et patriarche",
  "Beth": "Fille cadette d’Hershel, chanteuse",
  "Beth Greene": "Fille cadette d’Hershel, chanteuse",
  "Gouverneur": "Leader tyrannique de Woodbury",
  "Le Gouverneur": "Leader tyrannique de Woodbury",
  "Philip Blake": "Leader tyrannique de Woodbury",
  "Sasha": "Tireuse d’élite",
  "Sasha Williams": "Tireuse d’élite",
  "Tyreese": "Force tranquille du groupe",
  "Tyreese Williams": "Force tranquille du groupe",
  "Abraham": "Sergent costaud et sarcastique",
  "Abraham Ford": "Sergent costaud et sarcastique",
  "Rosita": "Combattante et mère de Coco",
  "Rosita Espinosa": "Combattante et mère de Coco",
  "Eugene": "Scientifique mullet et fabricant de munitions",
  "Eugène": "Scientifique mullet et fabricant de munitions",
  "Eugene Porter": "Scientifique mullet et fabricant de munitions",
  "Jesus": "Scout et combattant expert de Hilltop",
  "Paul Rovia": "Scout et combattant expert de Hilltop",
  "Ezekiel": "Roi du Royaume",
  "Roi Ezekiel": "Roi du Royaume",
  "Jerry": "Bras droit loyal et jovial d’Ezekiel",
  "Alpha": "Leader des Chuchoteurs",
  "Beta": "Bras droit massif d’Alpha",
  "Lydia": "Fille d’Alpha",
  "Gamma": "Espionne des Chuchoteurs (Mary)",
  "Aaron": "Recruteur d’Alexandria",
  "Gabriel": "Prêtre devenu guerrier",
  "Gabriel Stokes": "Prêtre devenu guerrier",
  "Princess": "Survivante excentrique et énergique",
  "Juanita Sanchez": "Survivante excentrique et énergique",
  "Pamela Milton": "Gouverneure du Commonwealth",
  "Mercer": "Commandant de l’armée du Commonwealth",
  "Lance Hornsby": "Bras droit manipulateur de Pamela",
  "Alexandria": "Communauté fortifiée, refuge principal",
  "La Zone sûre d’Alexandria": "Communauté fortifiée, refuge principal",
  "Hilltop": "Colonie agricole dirigée un temps par Maggie",
  "La Colline": "Colonie agricole dirigée un temps par Maggie",
  "Le Royaume": "Communauté monarchique d’Ezekiel",
  "Kingdom": "Communauté monarchique d’Ezekiel",
  "Sanctuaire": "Base industrielle des Sauveurs",
  "Le Sanctuaire": "Base industrielle des Sauveurs",
  "Woodbury": "Ville fortifiée du Gouverneur",
  "Terminus": "Piège mortel des cannibales",
  "Commonwealth": "Immense cité de 50 000 habitants",
  "Le Commonwealth": "Immense cité de 50 000 habitants",
  "Prison": "Refuge du groupe saisons 3-4",
  "La Prison": "Refuge du groupe saisons 3-4",
  "Atlanta": "Ville d’origine, saison 1"
};

function addTooltips() {
  const container = document.querySelector(".sum-content");
  if (!container) return;

  const keys = Object.keys(tooltips).sort((a, b) => b.length - a.length);
  const pattern = keys.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join("|");
  const regex = new RegExp(`(?<!\\p{L})(${pattern})(?!\\p{L})`, "giu");

  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
  const textNodes = [];
  while (walker.nextNode()) textNodes.push(walker.currentNode);

  textNodes.forEach(node => {
    const parent = node.parentNode;
    if (parent.closest(".tooltip")) return;

    const text = node.nodeValue;
    if (!regex.test(text)) return;
    regex.lastIndex = 0;

    const frag = document.createDocumentFragment();
    let last = 0;
    let m;
    while ((m = regex.exec(text)) !== null) {
      const start = m.index;
      if (start > last) frag.appendChild(document.createTextNode(text.slice(last, start)));

      const word = m[1];
      const key = keys.find(k => k.toLowerCase() === word.toLowerCase());

      const span = document.createElement("span");
      span.className = "tooltip";
      span.textContent = word;

      const tip = document.createElement("span");
      tip.className = "tooltiptext";
      tip.textContent = tooltips[key];
      span.appendChild(tip);

      frag.appendChild(span);
      last = start + word.length;
    }

    if (last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));

    parent.replaceChild(frag, node);
  });
}
async function sendChoice(btn, season, choice) {
  // Cherche tous les boutons dans le même container
  const buttons = btn.parentElement.querySelectorAll(".choice-btn");
  buttons.forEach(b => {
    b.disabled = true;
    b.classList.remove("selected");
  });

  btn.classList.add("selected");
  document.title = `formage fraise - ${page}`;
  try {
    const res = await fetch("https://sheet-snt.vercel.app/api/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ season, choice })
    });
    const result = await res.json();
    console.log(result.message);
  } catch (err) {
    console.error("Erreur:", err);
  }
}
    renderPage();
}
</script>
</html>